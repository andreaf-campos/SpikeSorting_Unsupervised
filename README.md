## **Unsupervised Spike Classification Algorithm Based on Wavelet Coefficients, Principal Components, and K-Means Clustering**

### **Authors**
- Andrea Fernanda Campos Pérez
- José Carlos Barreras Maldonado

*February, 2021.*

---
### Languages Used

![Python](https://img.shields.io/badge/Language-Python-blue?style=for-the-badge&logo=python)

---
### **Overview**
This repository contains an **unsupervised spike sorting algorithm** implemented in Python. The algorithm is designed to classify extracellularly recorded neuronal activity by extracting waveform features and clustering them using **Wavelet coefficients, Principal Component Analysis (PCA), and K-means clustering**. 

The repository includes:
- Functions Compiled with Cython for **denoising, waveform alignment, feature extraction, and clustering**.
- A Jupyter Notebook demonstrating the **full spike sorting pipeline** for processing **Neural Event (NEV) files**. (Commentaries in English/Spanish)
- The **detailed project report (PDF)** outlining the methodology, results, and analysis (in Spanish).
- A folder with **example NEV files** for testing the algorithm.

---
### **Background**
Extracellular recordings capture neuronal electrical activity, but **spike sorting** is essential to determine which neuron generated each spike. This classification enables the study of **single-neuron dynamics**, providing insights into the neural mechanisms underlying **decision-making, working memory, and sensory processing**.

The algorithm in this project processes extracellular signals recorded from **trained macaques** performing cognitive tasks, however, it can be applied to any kind of recorded signal by Blackrock Microsystems recording systems. The workflow consists of:
1. **Preprocessing NEV files**: Extracting spike timestamps and waveforms.
2. **Denoising**: Applying a **Savitzky-Golay filter** to smooth waveforms.
3. **Alignment**: Using **cubic spline interpolation** to align spikes to their minimum peak.
4. **Feature Extraction**: 
   - **Wavelet Transform** to capture time-frequency characteristics.
   - **PCA** to reduce dimensionality.
   - **Kolmogorov-Smirnov test** to select the most informative features.
5. **Clustering**: Applying **K-means clustering** to group spikes from different neurons.
6. **Evaluation**: Using **Pearson correlation, silhouette scores, and statistical tests**.
7. **Saving Results**: Storing classified spike data for further analysis.

---
### **Implementation Details**
The spike sorting algorithm is implemented in **Python** and optimized with **Cython**. The processing steps are as follows:

#### **1. NEV File Handling**
- Loads recorded extracellular spike data.
- Converts NEV files to DAT format for easier manipulation.
- The repository includes **example NEV files** for testing. Users who want to test the algorithm can simply clone the repository and use the path to the provided NEV files in the first stage of the code (NEV file extraction and DAT creation).
- The repository includes **example NEV files** for testing. Users who want to test the algorithm can simply clone the repository and use the path to the provided NEV files in the first stage of the code (NEV file extraction and DAT creation).
- **NEV files** are generated by **Blackrock Microsystems recording systems**, which capture neural events such as spike timestamps, event markers, and waveform snippets.

#### **2. Compiling and Importing Cython Code**
The **functions module** is written in **Cython** (`functions.pyx`) for optimized performance. 

- If using the **Jupyter Notebook**, Cython **auto-compiles** using `pyximport` (**recommended**). The snippet of code that does this is:
  ```python
  import pyximport
  pyximport.install(build_in_temp=False, inplace=True, language_level=3)
  import functions  # This will automatically compile functions.pyx if needed
  ```
- If you prefer **manual compilation**, run before using the **Spike Sorting Notebook**:
  ```sh
  python setup.py build_ext --inplace
  ```
  or
  ```sh
  cythonize -i functions.pyx
  ```
  This generates the necessary `.c` and `.so` (or `.pyd` on Windows) files.

---
### **Files in This Repository**

| File | Description |
|------|------------|
| `functions.pyx` | Cython-optimized module of functions for PCA, clustering, and evaluation metrics |
| `SpikeSorting_Unsupervised.ipynb` | Jupyter Notebook demonstrating the full spike sorting workflow |
| `SpikeSorting_Unsupervised_ProjectDetails_ACJB.pdf` | Full project report detailing the methodology and results (In Spanish) |
| `example_nev_files/` | Folder containing example NEV files for testing the algorithm |

---
### **Results & Visualization**
- **Spike Clusters**: Visualized in **3D feature space**.
- **Raster Plots**: Show neuronal activity across trials.
- **Stability Analysis**: Evaluates the consistency of neuron firing across trials.
- **Heatmaps**: Display density distributions of classified spikes.

---
### **How to Run the Algorithm**
1. Install dependencies:
   ```sh
   pip install numpy scipy scikit-learn pywavelets cython jupyter
   ```
2. Clone the repository:
   ```sh
   git clone https://github.com/andreaf-campos/SpikeSorting_Unsupervised.git
   cd SpikeSorting_Unsupervised
   ```
3. If using the Jupyter Notebook (**recommended**), Cython will **auto-compile on import** the `functions.pyx` module of functions.
4. If manual compilation of `functions.pyx` is needed, run beforehand:
   ```sh
   python setup.py build_ext --inplace
   ```
3. Run the **Jupyter Notebook**:
   ```sh
   jupyter notebook SpikeSorting_Unsupervised.ipynb
   ```
4. If using the example NEV files, specify their folder path in the first stage of the Notebook code (NEV files hnadling).

---
### **Future Improvements**
- **Explore alternative feature extraction techniques** (e.g., geometric features, energy-based methods).
- **Test alternative clustering algorithms** (e.g., DBSCAN, soft K-means, K-TOPS).
- **Optimize code execution** using **Numba** and **lookup tables**.
- **Validate performance on synthetic datasets** where spike identities are known.

---
### **Main References**
- Quiroga, R. Q., Nadasdy, Z., & Ben-Shaul, Y. (2004). *Unsupervised Spike Detection and Sorting with Wavelets and Superparamagnetic Clustering*. Neural Computation, 16(8), 1661–1687.
- Lewicki, M. (1998). *A review of methods for spike sorting: The detection and classification of neural action potentials*. Network: Comput. Neural Syst., 9, R53–R78.
- Caro-Martín, C. R., et al. (2018). *Spike sorting based on shape, phase, and distribution features, and K-TOPS clustering with validity and error indices*. Scientific Reports, 8(1), 17796.

---
### **License**
This project is licensed under the MIT License.

If you use this work in academic research, please cite the original authors:

Campos Pérez, A. F., & Barreras Maldonado, J. C. (2021).

